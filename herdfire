#!/usr/bin/python
"""
Herd Fire

A small script to help associate different Firefox profiles with different
copies of the Firefox app.

This is specific for the way Mac OS X launches apps, and BSD/Linux/Windows
will find it easier to just create a specific script/launcher/shortcut for
each profile than to copy the physical Firefox app.
"""
from __future__ import with_statement
from glob import glob
from os import chmod
from os.path import join, split
from plistlib import readPlist, writePlist

LAUNCH_SCRIPT = """#!/bin/sh
# Launch Firefox with a specific profile.

# This shell script was automatically generated by Herd Fire
# For more information, see:
# http://mikkel.hoegh.org/blog/2010/jan/22/introducing-herdfire/

# Start by launching Firefox with the correct profile.
"%(app_path)s/Contents/MacOS/firefox-bin" -P %(profile_name)s &
# Wait a moment...
sleep 4
# Then use AppleScript to get our newly launched app to the foreground.
osascript -e 'tell application "%(app_name)s" to activate'
"""

def main():
    """ Run our script as from the command line."""
    app_list = glob('/Applications/Firefox*.app')
    write_launch_script(app_list)
    plist_setup(app_list)

def write_launch_script(app_list):
    """Write a launch script for each of our Firefox.apps"""

    for app_path in app_list:
        path, app_name = split(app_path)

        # Strip off the initial "Firefox" and the .app suffix.
        profile_name = app_name[7:-4]

        # Strip separation chars from profile name.
        profile_name = profile_name.strip(' -_.')

        if not profile_name:
            profile_name = 'default'

        with open(join(app_path, 'Contents/MacOS/herdfire-launch'), 'w') as f:
            f.write(LAUNCH_SCRIPT % {
                'app_path': app_path,
                'profile_name': profile_name,
                'app_name': app_name[:-4]
            })

        # The equivalent of chmod 755 herdfire-launch
        chmod(join(app_path, 'Contents/MacOS/herdfire-launch'), 0755)


def plist_setup(app_list):
    """Change each Firefox app's PList to use the herdfire-launch script"""
    for app_path in app_list:
        plist = readPlist(join(app_path, 'Contents/Info.plist'))

        # Check to make sure we only mess with copies of Firefox.app,
        # not other apps that might be named "Firefox Somethingorother"
        if plist['CFBundleName'] == 'Firefox':
            plist['CFBundleExecutable'] = 'herdfire-launch'
            writePlist(plist, join(app_path, 'Contents/Info.plist'))


if __name__ == '__main__':
    main()

